---
import Layout from '../layouts/Layout.astro';
import GuestbookPosts from '../components/GuestbookPosts.astro';
import fetch from 'node-fetch';

interface Author {
  login: string;
  avatarUrl: string;
}

interface Comment {
  author: Author;
  body: string;
  createdAt: string;
}

interface Discussion {
  title: string;
  comments: {
    nodes: Comment[];
  };
}

interface Repository {
  discussion: Discussion;
}

interface GraphQLResponse {
  data?: {
    repository: Repository;
  };
}

const GH_API = import.meta.env.GH_API;
console.log(GH_API.length);

async function getGuestbookPosts(): Promise<GraphQLResponse> {
  let results = await fetch('https://api.github.com/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `bearer ${GH_API}`,
    },
    body: JSON.stringify({
      query: `{
        repository(owner: "sebdanielsson", name: "sebdanielsson.github.io") {
          discussion(number: 9) {
            title
            comments(last: 100) {
              nodes {
                author {
                  login
                  avatarUrl
                }
                body
                createdAt
              }
            }
          }
        }
      }`,
    }),
  });

  let guestbookPostsResponse: GraphQLResponse = await results.json();
  return guestbookPostsResponse;
}

const guestbookPostsResponse = await getGuestbookPosts();
const guestbookPosts = guestbookPostsResponse.data.repository.discussion.comments.nodes;
---

<Layout>
  <main class="main-width">
    <!-- <h1>Guestbook</h1> -->
    <div class="relative py-6">
      <img src="/img/kilroy.svg" class="mx-auto w-3/4 text-white md:w-1/2" />
      <button
        id="guestbook-post"
        class="absolute right-0 ml-auto -translate-y-[100%] rounded-xl bg-[--accent] px-4 py-2 text-base font-semibold text-white"
      >
        Post
      </button>
    </div>
    <div id="guestbook-content" class="">
      <script
        is:inline
        src="https://giscus.app/client.js"
        data-repo="sebdanielsson/sebdanielsson.github.io"
        data-repo-id="R_kgDOJITMkA"
        data-category="Guestbook"
        data-category-id="DIC_kwDOJITMkM4CcDrE"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="0"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="https://sebbo.io/styles/giscus-dark.css"
        data-lang="en"
        crossorigin="anonymous"
        async></script>
    </div>
    <div class="flex flex-col flex-wrap justify-between gap-12 md:flex-row">
      {
        guestbookPosts.map((post) => (
          <div class="post-container flex flex-auto justify-around">
            <GuestbookPosts post={post} />
          </div>
        ))
      }
    </div>

    <style>
      #guestbook-content {
        max-height: 0;
        transition: max-height 0.5s ease-out;
        overflow: hidden;
      }

      @media screen and (min-width: 768px) {
        .post-container:nth-child(1),
        .post-container:nth-child(2),
        .post-container:nth-child(3) {
          flex-basis: 25%;
        }

        .post-container:nth-child(4) {
          flex-basis: 30%;
          margin-left: 15%;
        }

        .post-container:nth-child(5) {
          flex-basis: 30%;
          margin-right: 15%;
        }
      }
    </style>

    <script is:inline>
      document.querySelectorAll('.post').forEach((post) => {
        const randomDegree = Math.random() * 30 - 15; // Random rotation between -20 and +20 degrees
        post.style.transform = `rotate(${randomDegree}deg)`;
      });

      document.getElementById('guestbook-post').addEventListener('click', function () {
        var guestbookDiv = document.getElementById('guestbook-content');
        var guestbookPost = document.getElementById('guestbook-post');
        // Check if the div is already expanded
        if (guestbookDiv.style.maxHeight !== '1000px') {
          // If not expanded, expand it
          guestbookDiv.style.maxHeight = '1000px';
          // Change text to close and make it red
          guestbookPost.innerHTML = 'Close';
          guestbookPost.style.backgroundColor = 'red';
        } else {
          // If already expanded, collapse it
          guestbookDiv.style.maxHeight = '0';
          // Change text to post and make it green
          guestbookPost.innerHTML = 'Post';
          // Remove the style attribute
          guestbookPost.style.backgroundColor = 'var(--accent)';
        }
      });
    </script>
  </main>
</Layout>
